steps:
  - type: meya.shopify.component.customer.order.list
    customer_id: (@ user.user_id )
    integration: integration.shopify
  - flow_set: orders

  - ask: What orders do you want to check
    buttons:
      - text: paid
        result: [paid]
      - text: pending
        result: [pending]
      - text: delivered
        result: [delivered]
      - text: refunded
        result: [refunded]
      - text: all
        result: []

  - say: Here are the orders I found...
  - delay: 1
  - type: meya.shopify.component.order.display
    orders: (@ flow.orders)
    filter: (@ flow.result)
    integration: integration.shopify

  - if: (@ flow.result)
    then:
      jump: orders found
    else: next

  - say: No orders available
    quick_replies:
     - text: start_over
       action:
         flow: flow.start
         transfer: true

  - (orders found)
  - ask:
    tiles: (@ flow.result)

  - type: meya.shopify.component.order.select
    order_id: (@ flow.result | int)
    orders: (@ flow.orders)
  - flow_set: selected_order

  - type: meya.shopify.component.order.status
    order: (@ flow.result)

  - case:
      paid:
        jump: paid
      refunded:
        jump: refunded
      delivered:
        jump: delivered
    default:
      jump: cant_help
    value: (@ flow.result)

  - (paid)
  - say: |
      Your order is still processing and could take up to 5 days to ship.
      We'll notify you when tracking is available.

  - say: Is there something you need help with on this order?
    quick_replies:
      # Not possible to change order item
      - text: Update shipping address
        action:
          flow: flow.order.update_shipping_address
          data:
            order_id: (@ flow.selected_order.id)
          transfer: true
      - text: Cancel order
        action:
          flow: flow.order.cancel
          data:
            order_id: (@ flow.selected_order.id)
          transfer: true
      - text: Nevermind
        action:
          flow: flow.start
          transfer: true

    # TODO: move to bot settings
#    composer:
#      visibility: hide

  - (in_transit)
  - say: Your order is expected to arrive in (@ flow.result.eta ) days.
    quick_replies:
      - text: Start over
        action:
          flow: flow.start
          transfer: true

  - (delivered)
  # ETA is not provided for API's. It's possible but is out of the scope for this task:
  # https://shopify.dev/docs/admin-api/rest/reference/shipping-and-fulfillment/fulfillmentevent
  - say: >
      Your order was delivered.
      What would like help with?
    quick_replies:
      - text: Refund
        action:
          flow: flow.order.refund
          data:
            order: (@ flow.selected_order)
          transfer: true
      - text: Write product review
        action:
          flow: flow.product.review
          data:
            product_id: (@ flow.selected_order['line_items'][0]['product_id'])
          transfer: true
      - text: Nevermind
        action:
          flow: flow.start
          transfer: true

  - (cant_help)
  - say: Sorry, I can't help you with this yet, but I'm learning.
    quick_replies:
      - text: Start over
        action:
          flow: flow.start
          transfer: true


  - (refunded)
  - say: That order was refunded. Please contact the store for further information.
    quick_replies:
      - text: Start over
        action:
          flow: flow.start
          transfer: true
