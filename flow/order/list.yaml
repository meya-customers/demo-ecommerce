steps:
  - (choose filter)
  - flow_set:
      fulfillment_status: any
      financial_status: any
      order_status: any

  - ask: Please choose the order filter
    buttons:
      - text: Fulfillment status
        action:
          jump: fulfillment status
      - text: Financial status
        action:
          jump: financial status
      - text: Order status
        action:
          jump: order status
      - text: See all orders
        result: any
  - flow_set: order_status
  - jump: orders query

  - (fulfillment status)
  - ask: Select the fulfillment status
    buttons:
      - text: shipped
        result: shipped
      - text: partial
        result: partial
      - text: unshipped
        result: unshipped
      - text: unfulfilled
        result: unfulfilled
      - text: Change filter
        action:
          jump: choose filter
  - flow_set: fulfillment_status
  - jump: order status

  - (financial status)
  - ask: Select the financial status
    buttons:
      - text: authorized
        result: authorized
      - text: pending
        result: pending
      - text: paid
        result: paid
      - text: partially_paid
        result: partially_paid
      - text: refunded
        result: refunded
      - text: voided
        result: voided
      - text: partially_refunded
        result: partially_refunded
      - text: unpaid
        result: unpaid
      - text: Change filter
        action:
          jump: choose filter
  - flow_set: financial_status

  - (order status)
  - ask: Select the order status
    buttons:
      - text: open
        result: open
      - text: closed
        result: closed
      - text: cancelled
        result: cancelled
      - text: any
        result: any
  - flow_set: order_status

  - (orders query)
  - type: meya.shopify.component.customer.order.list
    customer_id: (@ user.user_id )
    financial_status: (@ flow.financial_status)
    fulfillment_status: (@ flow.fulfillment_status)
    status: (@ flow.order_status)
    integration: integration.shopify
  - flow_set: orders

  - if: (@ flow.orders)
    then:
      jump: orders display
    else: next

  - say: Sorry! I didn't find any order for that filter.
    quick_replies:
      - text: Try again
        action:
          jump: choose filter
      - text: No
        action:
          flow: flow.start
          transfer: True


  - (orders display)
  - say: Here are the orders I found...
  - delay: 1
  - type: meya.shopify.component.order.display
    orders: (@ flow.orders)
    integration: integration.shopify

  - ask:
    tiles: (@ flow.result)

  - type: meya.shopify.component.order.select
    order_id: (@ flow.result | int)
    orders: (@ flow.orders)
  - flow_set: selected_order

  - type: meya.shopify.component.order.status
    order: (@ flow.result)

  - case:
      paid:
        jump: paid
      refunded:
        jump: refunded
      delivered:
        jump: delivered
    default:
      jump: cant_help
    value: (@ flow.result)

  - (paid)
  - say: |
      Your order is still processing and could take up to 5 days to ship.
      We'll notify you when tracking is available.

  - say: Is there something you need help with on this order?
    quick_replies:
      # Not possible to change order item
      - text: Update shipping address
        action:
          flow: flow.order.update_shipping_address
          data:
            order_id: (@ flow.selected_order.id)
          transfer: true
      - text: Cancel order
        action:
          flow: flow.order.cancel
          data:
            order_id: (@ flow.selected_order.id)
          transfer: true
      - text: Nevermind
        action:
          flow: flow.start
          transfer: true

    # TODO: move to bot settings
#    composer:
#      visibility: hide

  - (in_transit)
  - say: Your order is expected to arrive in (@ flow.result.eta ) days.
    quick_replies:
      - text: Start over
        action:
          flow: flow.start
          transfer: true

  - (delivered)
  # ETA is not provided for API's. It's possible but is out of the scope for this task:
  # https://shopify.dev/docs/admin-api/rest/reference/shipping-and-fulfillment/fulfillmentevent
  - say: >
      Your order was delivered.
      What would like help with?
    quick_replies:
      - text: Refund
        action:
          flow: flow.order.refund
          data:
            order: (@ flow.selected_order)
          transfer: true
      - text: Write product review
        action:
          flow: flow.product.review
          data:
            product_id: (@ flow.selected_order['line_items'][0]['product_id'])
          transfer: true
      - text: Nevermind
        action:
          flow: flow.start
          transfer: true

  - (cant_help)
  - say: Sorry, I can't help you with this yet, but I'm learning.
    quick_replies:
      - text: Start over
        action:
          flow: flow.start
          transfer: true


  - (refunded)
  - say: That order was refunded. Please contact the store for further information.
    quick_replies:
      - text: Start over
        action:
          flow: flow.start
          transfer: true
